{% extends 'base.html' %}
{% load static %}


{% block title %}Список товаров{% endblock title %}


{% block css %}
<link href="{% static 'css/pagination.css' %}" rel="stylesheet">
<link href="{% static 'app_shop/css/shop.css' %}" rel="stylesheet">
{% endblock css %}


{% block content %}
{% comment %} {% if filter_form %}
    {% include 'include/filter.html' %}
{% endif %} {% endcomment %}
<section class="products">
    <div class="products__container container">
        <div class="products__header">
            <h2 class="products__heading">Товары</h2>
        </div>
        {% include 'include/pagination.html' %}
        <ul class="products__list">
            {% for product in product_list %}
                <li class="products__item product-item">
                    <a href="{{ product.get_absolute_url }}" class="product-item__link">
                        <img src="{{ product.first_image_url }}" alt="Изображение товара {{ product.name }}" class="product-item__image">
                        <h3 class="product-item__heading">{{ product.name }}</h3>
                        <p class="product-item__description">{{ product.description|truncatechars:120 }}</p>
                        <span class="product-item__price">₽ {{ product.price|stringformat:"s" }}</span>
                    </a>
                    <form class="product-item__add-to-cart" action="{% url 'shop:add_to_cart' product.id  1 %}" method="POST" onsubmit="AddProductToCart(event)">
                        {% csrf_token %}
                        <button class="btn btn_reset btn_round" type="submit">
                            <svg class="btn__icon">
                                <use xlink:href="{% static 'images/sprite.svg' %}#cart"></use>
                            </svg>
                        </button>
                    </form>
                </li>            
            {% endfor %}
        </ul>
        {% include 'include/pagination.html' %}
    </div>
</section>
{% endblock content %}


{% block script %}
<script>
    const totalPrice = document.querySelector('#total_price');
    const totalQuantity = document.querySelector('#total_quantity');

    function AddProductToCart(event) {
        event.preventDefault();
        const actionForm = event.target;
        const actionFormBtn = actionForm.querySelector('.btn');
        actionFormBtn.disabled = true;
        const formData = new FormData(actionForm);
        fetch(actionForm.action, {
            method: 'POST',
            url: this.url,
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                totalPrice.textContent = parseFloat(data.total_price).toFixed(2);
                totalQuantity.textContent = data.total_quantity;
            }
        });
        actionFormBtn.disabled = false;
    };
    </script>
{% endblock script %}